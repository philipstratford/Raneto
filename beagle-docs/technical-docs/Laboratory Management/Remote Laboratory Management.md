# Remote Laboratory Management
Remote Laboratory Management is a feature of Beagle which is intended to solve a problem which arises when a laboratory is processing samples from multiple clinics which between them use at least one instance of Beagle which differs from that being used by the laboratory for laboratory management. For example, the Clinical Pathology laboratory uses the SATH instance of Beagle for laboratory management but also processes [Laboratory Samples](laboratory%20management.md) from the Equine Hospital, which uses a different instance of Beagle.

When all of the samples being processed in a laboratory are associated with [Laboratory Requests](laboratory%20management.md) which were created in the same instance of Beagle as the laboratory uses for laboratory management, looking up the details associated with a laboratory sample with only the Laboratory Sample ID (the barcode) simply requires querying the _LaboratorySample_ database table for that ID. However, a query on the _LaboratorySample_ table will return no results if the the sample is associated with a Laboratory Request which was created in a difference instance of Beagle, and it may not be possible to determine from the sample alone which instance of Beagle it originates from, meaning that laboratory staff would need to open every instance of Beagle from which the sample might have been generated and perform a sample ID lookup until they found a match. This is obviously not ideal.

The Remote Laboratory Management feature of Beagle solves this problem by keeping a single, centralised database of Laboratory Samples. If Remote Laboratory Management is enabled in an instance of Beagle, when a Laboratory Sample lookup is performed in that Beagle instance a request is made to the Beagle Laboratory Management Server API rather than directly to the _LaboratorySample_ table for that Beagle instance. If the response from the API indicates that the sample originated in the same Beagle instance as that from which the lookup is being performed, the application falls back to the Local Laboratory Management behaviour and displays information for the sample. If the API's response indicates that the sample originated in a different Beagle instance then a new browser tab is opened and the URL contained in the API response is loaded so as to display information regarding the Laboratory Sample in the correct instance of Beagle. For a more detailed explanation of this process, see [Laboratory Management Server Data Flow](#Laboratory-Management-Server-Data-Flow).

## Configuration
### Configuring the Beagle Laboratory Management Server
Before any instance of Beagle can be configured to use Remote Laboratory Management the Beagle Laboratory Management Server must be deployed. Once that's been done, a record must be added to the Laboratory Management Server database's _LaboratoryManagementClient_ table for each instance of Beagle which will be making use of the feature. There is currently no front end for the Beagle Laboratory Management Server so these records must be added directly into the database. The values for the record's columns should be as follows:

| Name | URL Prefix | Deleted |
| --- | --- | --- |
| A friendly name for the Beagle instance which will allow it to be easily identified when configuring that instance, as described below. | The base URL for the Beagle instance, including a trailing forward slash. This should be the part of the URL that appears before _Laboratory_ when you open the Laboratory Management page in the instance of Beagle. | Set this to FALSE (0) |

### Configuring a Beagle Instance
This configuration can only be performed after the Beagle Laboratory Management Server has been deployed and configured, as described above. 

The Remote Laboratory Management feature can be enabled on the _[System Configuration](system%20configuration.md)_ > _Labs_ > _General Settings_ page. Once enabled, a value must be entered in the _Laboratory Management Server API URL_ field, which should be the URL of the Laboratory Management Server. Currently this URL must end in a forward slash. Click the _Save_ button to save the entered URL (the Save button will be removed in a future release so that manual saving won't be necessary).

After a valid Laboratory Management Server API URL has been entered and saved, refresh the browser page. The _This Beagle Instance's Laboratory Management Client ID_ dropdown should now contain values which will be the values from the _Name_ column of the _LaboratoryManagementClient_ table in the Beagle Laboratory Management Server database. Select the option which matches the Beagle Instance being configured and click the _Save_ button again to commit the selection.

The Beagle instance is now configured to use Remote Laboratory Management.

## Laboratory Management Server Data Flow
### During Client Configuration
When the _Labs_ > _General Settings_ page is opened in System Configuration, Beagle makes a call to the Beagle Laboratory Management Server API (_api/LaboratoryManagementClients_), which returns a list of undeleted Laboratory Management Clients from the _LaboratoryManagementClient_ table. These records are used to populate the _Clients_ dropdown list on the _General Settings_ page.

### When a Laboratory Request is Created
When a Laboratory Request is created in an instance of Beagle where Remote Laboratory Management is enabled, in addition to the actions taken by the application for all Laboratory Requests, a posting is made to the Beagle Laboratory Management Server API (_api/LaboratoryManagementSamples_) for each Laboratory Sample associated with the Laboratory Request. A record is added to the Beagle Laboratory Management Server database's _LaboratoryManagementSample_ table for each posting.

### When a Laboratory Sample is Looked Up
When a Laboratory Sample ID is looked up in an instance of Beagle where Remote Laboratory Management is enabled, a request is initially made to the Beagle Laboratory Management Server API (_api/LaboratoryManagementSamples/GetLaboratoryRequestBySampleID_). If no result is returned or a result is returned where the value of the _LaboratoryManagementClientID_ field matches the value in the looking up Beagle instance's database in the _SystemConfiguration.LaboratoryManagementClientIdentifer_ column, the application proceeds as if Remote Laboratory Management was not enabled and filters the Laboratory Management page to display details of the Laboratory Request associated with the Laboratory Sample (or displays "No Results"). 

If a result is returned where the value of the _LaboratoryManagementClientID_ field differs from the value in the looking up Beagle instance's database in the _SystemConfiguration.LaboratoryManagementClientIdentifer_ column, the value from the API result's _URLPrefix_ field is combined with the application's built-in path to the Laboratory Management page and the Sample ID to open in a new browser tab the instance of Beagle which originated the Laboratory Request associated with the looked-up Laboratory Sample and display its details in the Laboratory Management page.